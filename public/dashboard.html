<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashControl Business - Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#0d0d0d; color:white; }
    header { background:linear-gradient(90deg,#8e44ad,#b8860b); padding:15px; font-size:22px; font-weight:700; text-align:center; }
    .chart-card { background:#1a1a1a; border-radius:12px; padding:15px; margin:20px auto; box-shadow:0 4px 20px rgba(0,0,0,0.6); max-width:1200px; }
    .chart { width:100%; height:400px; }
    .no-data-message { text-align: center; color: #aaa; padding: 20px; }
    .export-btn-container { text-align: center; margin: 20px auto; max-width: 1200px; }
    #btnExportar {
      background: #e74c3c;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }
    #btnExportar:hover { background: #c0392b; }
    .chart-footer {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
    }
  </style>
</head>
<body>

<header>ðŸ“Š DashControl Business - Dashboard</header>

<div class="export-btn-container">
    <button id="btnExportar">Baixar RelatÃ³rio em PDF</button>
</div>

<div id="dashboardContent">
    <div class="chart-card">
      <div id="chartVendas" class="chart"></div>
      <div id="footerVendas" class="chart-footer"></div>
    </div>
    <div class="chart-card">
      <div id="chartEstoque" class="chart"></div>
      <div id="footerEstoque" class="chart-footer"></div>
    </div>
    <div class="chart-card">
      <div id="chartFinanceiro" class="chart"></div>
      <div id="footerFinanceiro" class="chart-footer"></div>
    </div>
    <div class="chart-card">
      <div id="chartPagamentos" class="chart"></div>
      <div id="footerPagamentos" class="chart-footer"></div>
    </div>
    <div class="chart-card">
      <div id="chartLinha" class="chart"></div>
      <div id="footerLinha" class="chart-footer"></div>
    </div>
</div>

<script type="module">
  // ImportaÃ§Ã£o do Firebase
  import { db } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const charts = {};

  function renderChart(elementId, option) {
    if (!charts[elementId]) {
      charts[elementId] = echarts.init(document.getElementById(elementId));
      window.addEventListener("resize", () => charts[elementId].resize());
    }
    charts[elementId].setOption(option);
  }

  function showNoDataMessage(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = `<div class="no-data-message">${message}</div>`;
    }
  }

  // Nova funÃ§Ã£o para atualizar o rodapÃ©
  function atualizarRodape(footerId, texto) {
    const footerElement = document.getElementById(footerId);
    if (footerElement) {
      footerElement.innerHTML = texto;
    }
  }

  async function carregarDados() {
    try {
      const vendasSnap = await getDocs(collection(db, "vendas"));
      let vendas = vendasSnap.docs.map(doc => doc.data());

      const estoqueSnap = await getDocs(collection(db, "estoque"));
      let estoque = estoqueSnap.docs.map(doc => doc.data());

      const finSnap = await getDocs(collection(db, "financeiro"));
      let financeiro = finSnap.docs.map(doc => doc.data());

      montarGraficos(vendas, estoque, financeiro);
    } catch (e) {
      console.error("Erro ao carregar os dados: ", e);
      alert("Erro ao carregar os dados. Verifique sua conexÃ£o ou a configuraÃ§Ã£o do Firebase.");
    }
  }

  function montarGraficos(vendas, estoque, financeiro) {
    // ðŸ›’ Vendas por Produto (contagem)
    if (vendas.length > 0) {
      let contagemVendasPorProduto = {};
      vendas.forEach(v => {
        const produtoNome = v.produto;
        if (produtoNome) {
          contagemVendasPorProduto[produtoNome] = (contagemVendasPorProduto[produtoNome] || 0) + 1;
        }
      });
      const produtosData = Object.keys(contagemVendasPorProduto).map(p => ({
        name: p,
        value: contagemVendasPorProduto[p]
      }));

      renderChart("chartVendas", {
        title:{text:"ðŸ›’ Vendas por Produto (Contagem)", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item', formatter: "{b}: {c} unidades" },
        series:[{type:"pie", radius:["40%","70%"], data:produtosData, label:{color:'#fff'}}]
      });
      
      const totalVendas = Object.values(contagemVendasPorProduto).reduce((sum, count) => sum + count, 0);
      atualizarRodape("footerVendas", `Total de itens vendidos: ${totalVendas}`);

    } else {
      showNoDataMessage("chartVendas", "Nenhuma venda registrada.");
      atualizarRodape("footerVendas", "");
    }

    // ðŸ“¦ Estoque Atual
    if (estoque.length > 0) {
      const estoqueNomes = estoque.map(e => e.nome);
      const estoqueQtds = estoque.map(e => e.quantidade || 0);
      renderChart("chartEstoque", {
        title:{text:"ðŸ“¦ Estoque Atual", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        xAxis:{type:"category", data:estoqueNomes, axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"bar", data:estoqueQtds, itemStyle:{color:"#1abc9c"}, label:{show:true, color:"#fff"}}]
      });

      const totalItensEstoque = estoque.reduce((sum, item) => sum + (item.quantidade || 0), 0);
      atualizarRodape("footerEstoque", `Total de itens em estoque: ${totalItensEstoque}`);

    } else {
      showNoDataMessage("chartEstoque", "Nenhum produto no estoque.");
      atualizarRodape("footerEstoque", "");
    }

    // ðŸ’° Financeiro (Entradas x SaÃ­das)
    if (financeiro.length > 0) {
      const entradas = financeiro.reduce((s,f)=>s+(f.entrada||0),0);
      const saidas = financeiro.reduce((s,f)=>s+(f.saida||0),0);
      renderChart("chartFinanceiro", {
        title:{text:"ðŸ’° Entradas x SaÃ­das", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        series:[{type:"pie", radius:["40%","70%"], data:[{name:"Entradas", value:entradas},{name:"SaÃ­das", value:saidas}], label:{color:'#fff'}}]
      });

      const saldoTotal = entradas - saidas;
      atualizarRodape("footerFinanceiro", `Saldo Atual: R$ ${saldoTotal.toFixed(2)}`);

    } else {
      showNoDataMessage("chartFinanceiro", "Nenhum dado financeiro.");
      atualizarRodape("footerFinanceiro", "");
    }

    // ðŸ’³ Formas de Pagamento
    if (vendas.length > 0) {
      let formas = {};
      vendas.forEach(v => formas[v.pagamento] = (formas[v.pagamento] || 0) + v.valor);
      const pagamentosData = Object.keys(formas).map(f => ({
        name: f,
        value: formas[f]
      }));
      renderChart("chartPagamentos", {
        title:{text:"ðŸ’³ Formas de Pagamento", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        series:[{type:"pie", radius:["40%","70%"], data:pagamentosData, label:{color:"#fff"}}]
      });

      const totalRecebido = Object.values(formas).reduce((sum, val) => sum + val, 0);
      atualizarRodape("footerPagamentos", `Total Recebido: R$ ${totalRecebido.toFixed(2)}`);

    } else {
      showNoDataMessage("chartPagamentos", "Nenhuma venda registrada.");
      atualizarRodape("footerPagamentos", "");
    }

    // ðŸ“ˆ Receita ao Longo do Tempo
    if (vendas.length > 0) {
      let porData = {};
      vendas.forEach(v => { porData[v.data] = (porData[v.data] || 0) + v.valor; });
      const datas = Object.keys(porData).sort();
      const valores = datas.map(d => porData[d]);

      renderChart("chartLinha", {
        title:{text:"ðŸ“ˆ Receita ao Longo do Tempo", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'axis' },
        xAxis:{type:"category", data:datas, axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"line", data:valores, smooth:true, itemStyle:{color:"#d4af37"}}]
      });

      const totalReceita = valores.reduce((sum, val) => sum + val, 0);
      atualizarRodape("footerLinha", `Receita Total: R$ ${totalReceita.toFixed(2)}`);

    } else {
      showNoDataMessage("chartLinha", "Nenhuma venda para exibir a receita.");
      atualizarRodape("footerLinha", "");
    }
  }

  function exportarPDF() {
    document.getElementById('btnExportar').style.display = 'none';

    const element = document.getElementById('dashboardContent');
    const options = {
      filename: 'Relatorio-DashControl.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    html2pdf().set(options).from(element).save().then(() => {
        document.getElementById('btnExportar').style.display = 'block';
    });
  }

  document.getElementById('btnExportar').addEventListener('click', exportarPDF);

  carregarDados();
</script>

</body>
</html>
